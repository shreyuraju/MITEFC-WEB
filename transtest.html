<!DOCTYPE html>
<html>
  <head>
    <title>Call JavaScript function from form</title>
  </head>
  <body>
    <a href="index.html">Home</a>
    <a href="updateAmount.html">Update</a>
    <a href="viewUsers.html">Users</a>
    <a href="tokencount.html">Token Count</a>
    <a href="viewTransaction.html">Transactions</a>
    <hr />
    <label for="sort">Sort by:</label>
    <select id="sort">
      <option selected>Choose Soryby</option>
      <option value="usn">USN</option>
      <option value="utr">UTR</option>
      <option value="date">Date</option>
      <option value="mode">Mode</option>
      <option value="amount">Amount</option>
    </select>

    <table id="myTable">
      <thead>
        <tr>
          <th id="usn">USN</th>
          <th id="utr">UTR</th>
          <th id="date">Date</th>
          <th id="mode">Mode</th>
          <th id="amount">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <br />
    <table id="totalTable">
      <thead>
        <tr>
          <th>Credited</th>
          <th>Debited</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="total"></div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        set,
        child,
        push,
        update,
        onValue, // added this line
      } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

      // Function to check for network connectivity
      function isOnline() {
        return navigator.onLine;
      }

      const firebaseConfig = {
        apiKey: "AIzaSyAacDD6L6X9dsLrQiWehiIEpLhPK7J7I3I",
        authDomain: "mite-fc.firebaseapp.com",
        databaseURL:
          "https://mite-fc-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mite-fc",
        storageBucket: "mite-fc.appspot.com",
        messagingSenderId: "389675299033",
        appId: "1:389675299033:web:b59fd72c9d8442a4d90ec8",
        measurementId: "G-HET59T2JMN",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      const rtdb = getDatabase(app);

      // Get a reference to the "users" node in the database
      const usersRef = ref(rtdb, "admin/alltransaction");

      
      let credit = 0;
      let debit = 0;

      // Attach a listener to the "value" event to read the data once
      onValue(usersRef, (snapshot) => {
        if (isOnline()) {
          const tableBody = document.querySelector("#myTable tbody");

          const rows = tableBody.rows;
          // Get a reference to the select element
          const select = document.querySelector("#sort");

          // Attach an event listener to the select element
          select.addEventListener("change", () => {
            // Get the selected value
            const selectedValue = select.value;

            // Get the table body and rows
            const tableBody = document.querySelector("#myTable tbody");
            const rows = tableBody.rows;

            // Convert the rows NodeList to an array
            const rowsArray = Array.from(rows);

            // Sort the rows array based on the selected heading
            rowsArray.sort((row1, row2) => {
              const cell1Value = row1.cells[selectedValue].textContent.trim();
              const cell2Value = row2.cells[selectedValue].textContent.trim();

              return cell1Value.localeCompare(cell2Value);
            });

            // Append the sorted rows to the table body
            rowsArray.forEach((row) => {
              tableBody.appendChild(row);
            });
          });

          // Clear the table
          tableBody.innerHTML = "";

          // Loop through the child nodes of the snapshot
          snapshot.forEach((childSnapshot) => {
            // Get the data for the child node
            const data = childSnapshot.val();
            const USN = data.USN;
            const amount = data.amount;
            const date = data.date;
            const mode = data.mode;
            const utr = data.utr;

            // Create a new row in the table
            const newRow = tableBody.insertRow(0);
            // Add the data to the new row
            const usnCell = newRow.insertCell();
            usnCell.textContent = USN;

            const utrCell = newRow.insertCell();
            utrCell.textContent = utr;

            const dateCell = newRow.insertCell();
            dateCell.textContent = date;

            const modeCell = newRow.insertCell();
            modeCell.textContent = mode;

            const amtCell = newRow.insertCell();
            if (mode == "credit") {
              let icredit = parseInt(amount);
              credit += icredit;
              amtCell.textContent = "+" + amount;
            } else if (mode == "debit") {
              let idebit = parseInt(amount);
              debit += idebit;
              amtCell.textContent = "-" + amount;
            }
          });
          console.log(credit);
          console.log(debit);

          const totaltableBody = document.querySelector("#totalTable tbody");
          // Clear the table
          totaltableBody.innerHTML = "";

          // Create a new row in the table
          const newRow = totaltableBody.insertRow(0);
          // Add the data to the new row
          const creditCell = newRow.insertCell();
          creditCell.textContent = credit;

          const debitCell = newRow.insertCell();
          debitCell.textContent = debit;

          const totalCell = newRow.insertCell();
          totalCell.textContent = credit + debit;
        } else {
          alert("Please check your network connection and try again.");
        }
      });
    </script>
  </body>
</html>
